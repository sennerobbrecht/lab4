<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Live locatie, verkeersborden & navigatie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
  <!-- Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100vw; }
    /* Knoppen rechtsonder */
    #controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    #controls button {
      padding: 8px 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #controls button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    /* Instructies paneel */
    .leaflet-routing-container {
      max-height: 40vh;
      overflow-y: auto;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="controls">
    <button id="startBtn" style="display:none;">Rit starten</button>
    <button id="stopBtn" style="display:none;">Navigatie stoppen</button>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/proj4@2.8.0/dist/proj4.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script>
    // 1) Kaart & CRS
    const map = L.map('map').setView([51.02707, 4.48096], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
    proj4.defs("EPSG:31370",
      "+proj=lcc +lat_0=90 +lon_0=4.367486666666667 " +
      "+lat_1=51.1666672333333 +lat_2=49.8333339 " +
      "+x_0=150000.013 +y_0=5400088.438 " +
      "+ellps=intl +towgs84=-106.8686,52.2978,-103.7239,0.3366," +
      "-0.457,1.8422,-1.2747 +units=m +no_defs"
    );

    // 2) Marker & cirkel
    const userMarker = L.circleMarker([0,0], {
      radius:7, fillColor:'#136AEC', color:'#fff',
      weight:2, opacity:1, fillOpacity:0.8
    }).addTo(map);
    const accuracyCircle = L.circle([0,0], {
      radius:0, color:'#136AEC',
      weight:1, fillColor:'#136AEC', fillOpacity:0.2
    }).addTo(map);

    // 3) State
    let routingControl = null;
    let lastLatLng = null;
    let isNavigating = false;
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');

    // 4) Geocoder (altijd uitgeklapt) 
    const geocoder = L.Control.geocoder({
      collapsed: false,
      placeholder: 'Voer bestemming in…',
      defaultMarkGeocode: false,
      geocoder: L.Control.Geocoder.nominatim()
    }).addTo(map);

    // Enter-toets afvangen
    const geocoderInput = document.querySelector('.leaflet-control-geocoder-form input');
    geocoderInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const query = this.value;
        geocoder.options.geocoder.geocode(query, results => {
          if (results && results.length > 0) {
            geocoder.fire('markgeocode', { geocode: results[0] });
          }
        });
      }
    });

    geocoder.on('markgeocode', e => {
      const dest = e.geocode.center;
      if (!lastLatLng) {
        alert('Even wachten op je locatie…');
        return;
      }
      // route maken of updaten
      if (routingControl) {
        routingControl.setWaypoints([ lastLatLng, dest ]);
      } else {
        routingControl = L.Routing.control({
          waypoints: [ lastLatLng, dest ],
          router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
          showAlternatives: false,
          fitSelectedRoutes: true,
          routeWhileDragging: false,
          draggableWaypoints: false,
          addWaypoints: false,
          collapsible: true,
          createMarker: () => null,
          lineOptions: { styles:[{ weight:4 }] }
        }).addTo(map);
      }
      // na route-berekening: overzicht & startknop tonen
      routingControl.once('routesfound', evt => {
        map.fitBounds(evt.routes[0].bounds);
        startBtn.style.display = 'block';
      });
    });

    // 5) Locatie ophalen
    function updateLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude: lat, longitude: lng, accuracy } = pos.coords;
        if (accuracy > 100) return;
        lastLatLng = L.latLng(lat, lng);
        map.fire('locationfound', { latlng: lastLatLng, accuracy });
      }, ()=>{}, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    // 6) locationfound handler
    map.on('locationfound', e => {
      const { lat, lng } = e.latlng;
      const acc = e.accuracy;
      userMarker.setLatLng([lat, lng]);
      accuracyCircle.setLatLng([lat, lng]).setRadius(acc);

      // verkeersborden
      const r=300;
      const [x,y] = proj4("EPSG:4326","EPSG:31370",[lng,lat]);
      const bbox = [x-r,y-r,x+r,y+r].join(',');
      fetch(
        'https://opendata.apps.mow.vlaanderen.be/opendata-geoserver/awv/wfs?'+
        'service=WFS&version=1.1.0&request=GetFeature'+
        '&typeName=awv:Verkeersborden.Vlaanderen_Borden'+
        '&srsName=EPSG:31370&outputFormat=application/json'+
        `&bbox=${bbox},EPSG:31370`
      )
      .then(r=>r.json())
      .then(data=>{
        if(map._bordGroup) map.removeLayer(map._bordGroup);
        const fg=L.featureGroup();
        data.features.forEach(f=>{
          const [bx,by]=f.geometry.coordinates;
          const [lonn,latt]=proj4("EPSG:31370","EPSG:4326",[bx,by]);
          const pt=L.latLng(latt,lonn);
          if(map.distance([lat,lng],pt)<=r) L.marker(pt).addTo(fg);
        });
        fg.addTo(map);
        map._bordGroup = fg;
      });

      // kaart volgen tijdens navigatie
      if (isNavigating) {
        map.setView([lat,lng], map.getZoom());
      }
    });

    // 7) Start/Stop knoppen
    startBtn.onclick = () => {
      if (!routingControl) return;
      isNavigating = true;
      startBtn.style.display = 'none';
      stopBtn.style.display  = 'block';
      map.setZoom(17);
    };
    stopBtn.onclick = () => {
      isNavigating = false;
      stopBtn.style.display  = 'none';
      map.removeControl(routingControl);
      routingControl = null;
      startBtn.style.display = 'none';
    };

    // 8) Beginnen met locatie-updates
    updateLocation();
    setInterval(updateLocation, 30000);
  </script>
</body>
</html>














