<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Live locatie, verkeersborden & navigatie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- Leaflet Routing Machine CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"
  />
  <!-- Leaflet Control Geocoder CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
  />
  <style>
    #map { height: 100vh; margin: 0; padding: 0; }
    body { margin: 0; }
  </style>
</head>
<body>
  <h3 style="padding:10px; margin:0;">
    Live locatie, verkeersborden binnen 300 m & navigatie
  </h3>
  <div id="map"></div>

  <!-- Proj4, Leaflet, Routing Machine & Geocoder -->
  <script src="https://unpkg.com/proj4@2.8.0/dist/proj4.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // --- 1) Kaart initialiseren ---
    const map = L.map('map').setView([51.02707, 4.48096], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap-bijdragers'
    }).addTo(map);

    // --- 2) CRS-definities voor projecties ---
    proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
    proj4.defs("EPSG:31370",
      "+proj=lcc +lat_0=90 +lon_0=4.367486666666667 " +
      "+lat_1=51.1666672333333 +lat_2=49.8333339 " +
      "+x_0=150000.013 +y_0=5400088.438 " +
      "+ellps=intl +towgs84=-106.8686,52.2978,-103.7239,0.3366," +
      "-0.457,1.8422,-1.2747 +units=m +no_defs"
    );

    // --- 3) Marker + cirkel voor live-locatie ---
    const userMarker = L.circleMarker([0,0], {
      radius: 7,
      fillColor: '#136AEC',
      color: '#fff',
      weight: 2,
      opacity: 1,
      fillOpacity: 1
    }).addTo(map);
    const accuracyCircle = L.circle([0,0], {
      radius: 0,
      color: '#136AEC',
      weight: 1,
      fillColor: '#136AEC',
      fillOpacity: 0.15
    }).addTo(map);

    // --- 4) Routing Machine control variabele ---
    let routingControl = null;

    // --- 5) Voeg geocoder (adres-zoekbox) toe ---
    const geocoderControl = L.Control.geocoder({
      placeholder: 'Zoek een adres…',
      defaultMarkGeocode: false,
      geocoder: L.Control.Geocoder.nominatim()
    })
    .on('markgeocode', function(e) {
      const center = e.geocode.center;
      // update bestemming van de route
      if (routingControl) {
        routingControl.spliceWaypoints(1, 1, center);
      } else {
        // als nog geen routingControl bestaat, maak 'm meteen
        routingControl = L.Routing.control({
          waypoints: [
            userMarker.getLatLng(),
            center
          ],
          router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1'
          }),
          showAlternatives: false,
          lineOptions: { styles: [{ weight: 4 }] },
          createMarker: (i, wp) => L.marker(wp.latLng, { draggable: i === 1 })
        }).addTo(map);
      }
      // centreer op bestemming
      map.setView(center, 15);
    })
    .addTo(map);

    // --- 6) Functie om live-locatie op te halen (GPS met goede accuracy) ---
    function changeLocation() {
      console.log('> changeLocation(): nieuwe locatie opvragen…');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude: lat, longitude: lng, accuracy } = pos.coords;
        console.log('Location found at', new Date().toLocaleTimeString(),
                    { lat, lng }, 'accuracy:', accuracy, 'm');

        // negeer slechte fixes
        if (accuracy > 100) {
          console.warn('Overslaan vanwege slechte nauwkeurigheid:', accuracy, 'm');
          return;
        }
        // vuurt Leaflet-event
        map.fire('locationfound', { latlng: L.latLng(lat,lng), accuracy });
      }, err => {
        console.warn('Geolocation error:', err.message);
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    // --- 7) Handler voor 'locationfound' (marker, cirkel, borden & routing) ---
    map.on('locationfound', e => {
      const { lat, lng } = e.latlng;
      const accuracy    = e.accuracy;

      // update marker & cirkel
      userMarker.setLatLng([lat, lng]);
      accuracyCircle.setLatLng([lat, lng]).setRadius(accuracy);

      // initialiseer routingControl bij eerste fix
      if (!routingControl) {
        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(lat, lng), // start = jouw locatie
            L.latLng(lat, lng)  // placeholder bestemming
          ],
          router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1'
          }),
          showAlternatives: false,
          lineOptions: { styles: [{ weight: 4 }] },
          createMarker: (i, wp) => L.marker(wp.latLng, { draggable: i === 1 })
        }).addTo(map);

        // laat gebruiker klikken om bestemming te kiezen
        map.on('click', evt => {
          routingControl.spliceWaypoints(1, 1, evt.latlng);
        });
      } else {
        // update alleen startpunt bij verplaatsing
        routingControl.spliceWaypoints(0, 1, L.latLng(lat, lng));
      }

      // Verkeersborden binnen 300 m ophalen
      const radius = 300;
      const [userX, userY] = proj4("EPSG:4326", "EPSG:31370", [lng, lat]);
      const bbox = [
        userX - radius, userY - radius,
        userX + radius, userY + radius
      ].join(',');
      const wfsUrl =
        'https://opendata.apps.mow.vlaanderen.be/opendata-geoserver/awv/wfs?' +
        'service=WFS&version=1.1.0&request=GetFeature' +
        '&typeName=awv:Verkeersborden.Vlaanderen_Borden' +
        '&srsName=EPSG:31370&outputFormat=application/json' +
        `&bbox=${bbox},EPSG:31370`;

      fetch(wfsUrl)
        .then(r => r.json())
        .then(data => {
          if (map._bordGroup) map.removeLayer(map._bordGroup);
          const fg = L.featureGroup();
          data.features.forEach((feat, i) => {
            const [x, y] = feat.geometry.coordinates;
            const [lon2, lat2] = proj4("EPSG:31370","EPSG:4326",[x,y]);
            const pt = L.latLng(lat2, lon2);
            if (map.distance([lat, lng], pt) <= radius) {
              const code = feat.properties.bordcode || 'Onbekend';
              L.marker(pt).bindPopup(
                `<b>Bord ${i+1}</b><br>` +
                `ID: ${feat.properties.BordID || '–'}<br>` +
                `Code: ${code}<br>` +
                `Afstand: ${Math.round(map.distance([lat,lng], pt))} m`
              ).addTo(fg);
            }
          });
          fg.addTo(map);
          map._bordGroup = fg;
        })
        .catch(err => console.error('Fout bij WFS:', err));
    });

    // --- 8) Start periodic updates ---
    changeLocation();                   // eerste meting
    setInterval(changeLocation, 30000); // daarna elke 30 s
  </script>
</body>
</html>











