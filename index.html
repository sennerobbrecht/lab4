<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Navigatie & verkeersborden</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- Routing Machine CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"
  />
  <!-- Geocoder CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
  />

  <!-- Turf.js voor punt–lijn afstanden -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100vw; }

    /* de “Route starten” knop, standaard verborgen */
    #start-route-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: #136AEC;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #start-route-btn.show { display: block; }

    .leaflet-routing-container {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      width: 300px;
      max-height: 50vh;
      overflow-y: auto;
      background: rgba(255,255,255,0.9);
      padding: 8px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="start-route-btn">Route starten</button>

  <!-- Libs -->
  <script src="https://unpkg.com/proj4@2.8.0/dist/proj4.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // 1) Init kaart
    const map = L.map('map').setView([0,0], 1);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'&copy; OpenStreetMap'
    }).addTo(map);

    proj4.defs("EPSG:4326","+proj=longlat +datum=WGS84 +no_defs");
    proj4.defs("EPSG:31370",
      "+proj=lcc +lat_0=90 +lon_0=4.367486666666667 " +
      "+lat_1=51.1666672333333 +lat_2=49.8333339 " +
      "+x_0=150000.013 +y_0=5400088.438 " +
      "+ellps=intl +towgs84=-106.8686,52.2978,-103.7239,0.3366," +
      "-0.457,1.8422,-1.2747 +units=m +no_defs"
    );

    // 2) Markers & layer
    const userMarker     = L.circleMarker([0,0],{radius:6,fillColor:'#136AEC',color:'#fff',weight:2,fillOpacity:1}).addTo(map);
    const accuracyCircle = L.circle([0,0],{radius:0,color:'#136AEC',weight:1,fillColor:'#136AEC',fillOpacity:0.15}).addTo(map);
    const bordenGroup    = L.layerGroup().addTo(map);

    // 3) Globals
    let routingControl = null,
        currentPos     = null,
        currentDest    = null,
        firstLoad      = true,
        followRoute    = false;
    const startBtn = document.getElementById('start-route-btn');

    // 4) Geocoder + route tekenen & borden laden
    const geocoder = L.Control.geocoder({
      collapsed:false,
      placeholder:'Voer bestemming in…',
      defaultMarkGeocode:false,
      geocoder:L.Control.Geocoder.nominatim()
    }).addTo(map);

    geocoder.on('markgeocode', e => {
      currentDest = e.geocode.center;
      bordenGroup.clearLayers();
      if (routingControl) map.removeControl(routingControl);

      routingControl = L.Routing.control({
        waypoints:[currentPos, currentDest],
        router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
        showAlternatives:false,
        fitSelectedRoutes:false,
        routeWhileDragging:false,
        draggableWaypoints:false,
        addWaypoints:false,
        collapsible:true,
        createMarker:()=>null,
        lineOptions:{styles:[{weight:4,color:'#136AEC'}]}
      }).addTo(map);

      routingControl.once('routesfound', evt => {
        plotSignsAlongRoute(evt.routes[0]).then(() => {
          startBtn.classList.add('show');
        });
      });
    });

    // 5) “Route starten” knop — zoom + init follow + hide knop
    startBtn.addEventListener('click', () => {
      if (!currentPos) return;
      followRoute = true;  // zet follow flag aan
      map.setView(currentPos, 19);  // eerste keer centreren + zoom
      startBtn.classList.remove('show');  // knop verbergen na starten
    });

    // 6) Live locatie via watchPosition
    function onPositionUpdate(pos) {
      const {latitude:lat, longitude:lng, accuracy:acc} = pos.coords;
      currentPos = L.latLng(lat,lng);
      userMarker.setLatLng(currentPos);
      accuracyCircle.setLatLng(currentPos).setRadius(acc);

      if (firstLoad) {
        map.setView(currentPos, 15);
        firstLoad = false;
      }

      if (!routingControl || !currentDest) {
        loadAndPlotSigns(currentPos,300);
      } else {
        routingControl.setWaypoints([currentPos, currentDest]);
        routingControl.once('routesfound', ev => plotSignsAlongRoute(ev.routes[0]));
      }

      // na de eerste recenter, reset followRoute zodat de kaart niet meer verschuift
      if (followRoute) {
        followRoute = false;
      }
    }
    navigator.geolocation.watchPosition(onPositionUpdate, console.warn, {enableHighAccuracy:true, timeout:10000, maximumAge:0});

    // 7) Verkeersborden periodiek laden (30s)
    setInterval(() => {
      if (!currentPos) return;
      if (!routingControl && !currentDest) {
        loadAndPlotSigns(currentPos,300);
      } else if (routingControl && currentDest) {
        routingControl.spliceWaypoints(0,1,currentPos);
        routingControl.once('routesfound', ev => plotSignsAlongRoute(ev.routes[0]));
      }
    },30000);

    // 8) Losse GPS‐borden (300 m)
    function loadAndPlotSigns(latlng,radius){
      const [ux,uy] = proj4("EPSG:4326","EPSG:31370",[latlng.lng,latlng.lat]);
      const url = 'https://opendata.apps.mow.vlaanderen.be/opendata-geoserver/awv/wfs?'+
        'service=WFS&version=1.1.0&request=GetFeature'+
        '&typeName=awv:Verkeersborden.Vlaanderen_Borden'+
        '&srsName=EPSG:31370&outputFormat=application/json'+
        `&bbox=${ux-radius},${uy-radius},${ux+radius},${uy+radius},EPSG:31370`;
      fetch(url).then(r=>r.json()).then(data=>{
        bordenGroup.clearLayers();
        data.features.forEach((f,i)=>{
          const [x,y]=f.geometry.coordinates;
          const [lng2,lat2]=proj4("EPSG:31370","EPSG:4326",[x,y]);
          if(map.distance(latlng,[lat2,lng2])<=radius){
            L.marker([lat2,lng2])
             .bindPopup(`<b>Bord ${i+1}</b><br>Code: ${f.properties.bordcode||'–'}<br>` +
                        `Afstand: ${Math.round(map.distance(latlng,[lat2,lng2]))} m`)
             .addTo(bordenGroup);
          }
        });
      }).catch(console.error);
    }

    // 9) Borden langs de route (≤1 km, ≤30 m)
    function plotSignsAlongRoute(route){
      return new Promise(resolve=>{
        bordenGroup.clearLayers();
        const coords=route.coordinates.map(c=>[c.lng,c.lat]);
        let cumDist=0, sliced=[coords[0]];
        for(let i=1;i<coords.length;i++){
          cumDist+=turf.distance(turf.point(coords[i-1]),turf.point(coords[i]),{units:'meters'});
          if(cumDist>1000) break;
          sliced.push(coords[i]);
        }
        const line=turf.lineString(sliced);
        const bbox=turf.bbox(line);
        const [minX0,minY0]=proj4("EPSG:4326","EPSG:31370",[bbox[0],bbox[1]]);
        const [maxX0,maxY0]=proj4("EPSG:4326","EPSG:31370",[bbox[2],bbox[3]]);
        const buf=30;
        const url='https://opendata.apps.mow.vlaanderen.be/opendata-geoserver/awv/wfs?'+
          'service=WFS&version=1.1.0&request=GetFeature'+
          '&typeName=awv:Verkeersborden.Vlaanderen_Borden'+
          '&srsName=EPSG:31370&outputFormat=application/json'+
          `&bbox=${minX0-buf},${minY0-buf},${maxX0+buf},${maxY0+buf},EPSG:31370`;
        fetch(url)
          .then(r=>r.json())
          .then(data=>{
            data.features.forEach((f,i)=>{
              const [x,y]=f.geometry.coordinates;
              const [lng3,lat3]=proj4("EPSG:31370","EPSG:4326",[x,y]);
              const d=turf.pointToLineDistance(turf.point([lng3,lat3]),line,{units:'meters'});
              if(d<=30){
                L.marker([lat3,lng3])
                 .bindPopup(`<b>Bord ${i+1}</b><br>Code: ${f.properties.bordcode||'–'}<br>`+
                            `Dist. lijn: ${d.toFixed(0)} m`)
                 .addTo(bordenGroup);
              }
            });
            resolve();
          })
          .catch(err=>{console.error(err); resolve();});
      });
    }
  </script>
</body>
</html>